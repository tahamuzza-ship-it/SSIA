<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Artes Marciales â€” Clases 150â€“192</title>

  <!-- LibrerÃ­as -->
  <link href="https://unpkg.com/tabulator-tables@5.4.1/dist/css/tabulator.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script src="https://unpkg.com/tabulator-tables@5.4.1/dist/js/tabulator.min.js"></script>

  <style>
    :root{
      --bg:#0f1720;
      --card:#0f1725;
      --muted:#cfcfcf;
      --accent:#DC143C;
      --accent-2:#FFD700;
      --accent-3:#2D5016;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;
      background: linear-gradient(180deg, #0b0f14 0%, #0f1720 100%);
      color:var(--muted);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:1250px;margin:24px auto;padding:20px;}
    .hero{
      display:flex; gap:20px; align-items:center; background: linear-gradient(90deg, rgba(220,20,60,0.06), rgba(45,80,22,0.03));
      border-left:6px solid var(--accent); border-right:6px solid var(--accent-3); padding:18px; border-radius:8px;
    }
    .hero-img{width:170px;height:110px;object-fit:cover;border-radius:6px;flex:0 0 170px;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
    .hero-info h1{margin:0;font-size:26px;color:var(--accent);font-weight:700}
    .hero-info p{margin:6px 0 0;color:var(--accent-2);font-weight:600;font-size:13px}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}

    .btn{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:6px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn:hover{transform:translateY(-2px)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:8px;border:1px solid rgba(255,215,0,0.06)}
    .card h3{margin:0 0 10px;color:var(--accent);font-size:16px;font-weight:800}

    .stats{display:flex;gap:12px}
    .stat{flex:1;padding:14px;border-radius:6px;background:linear-gradient(90deg, rgba(45,80,22,0.08), rgba(220,20,60,0.02));text-align:center}
    .stat .n{font-family: 'Playfair Display', serif; font-size:22px; color:var(--accent-2); font-weight:800}
    .stat .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:6px}

    .charts {display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:16px}
    canvas{max-height:260px}

    .table-area{margin-top:18px}
    .filter-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .filter-row select,.filter-row input{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--muted)}
    #dataTable{min-height:220px}

    /* Hover / contrast fixes */
    .card:hover, .stat:hover { box-shadow: 0 8px 28px rgba(0,0,0,0.5); }
    .card:hover, .stat:hover, .tabulator .tabulator-row:hover { color: #0b0b0b !important; }
    .tabulator .tabulator-row .tabulator-cell a{ color:#81C784 !important; font-weight:700 }
    .tabulator .tabulator-row .tabulator-cell a:hover{ color:#0b0b0b !important; text-decoration:underline }
    .footer{margin-top:26px;text-align:center;color:#9fd69f;font-size:13px}
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
      .charts{grid-template-columns:1fr}
      .hero{flex-direction:column;align-items:flex-start}
      .hero-img{width:100%;height:160px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero card">
      <!-- hero.jpg: si no existe, reemplaza ruta o sube la imagen en assets/hero.jpg -->
      <img class="hero-img" src="assets/hero.jpg" alt="Artes Marciales â€” Hero image" onerror="this.style.display='none'">
      <div class="hero-info">
        <h1>ðŸ¥‹ Artes Marciales â€” Clases 150 a 192</h1>
        <p>Repositorio interactivo â€” organiza & explora enlaces por clase y plataforma</p>
        <div style="margin-top:10px;font-size:13px;color:var(--muted)">Visual: imagen hero, descarga CSV y exporta la tabla filtrada</div>
      </div>

      <div class="controls">
        <button id="btnDownloadCSV" class="btn">Descargar CSV</button>
        <button id="btnExportVisible" class="btn ghost" title="Exportar filas visibles">Exportar visibles</button>
        <button id="btnOpenAll" class="btn ghost" title="Abrir enlaces de la tabla (filtrados)">Abrir enlaces</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Resumen</h3>
        <div class="stats" id="statsContainer">
          <div class="stat"><div class="n" id="totalContent">0</div><div class="label">Total de contenidos</div></div>
          <div class="stat"><div class="n" id="totalClasses">0</div><div class="label">Clases cubiertas</div></div>
          <div class="stat"><div class="n" id="totalPlatforms">0</div><div class="label">Plataformas</div></div>
        </div>
      </div>

      <div class="card">
        <h3>DistribuciÃ³n por Plataforma</h3>
        <canvas id="platformChart"></canvas>
      </div>

      <div class="card">
        <h3>Contenido por Clase (top)</h3>
        <canvas id="classCountChart"></canvas>
      </div>
    </div>

    <div class="charts">
      <div class="card">
        <h3>Clases Ãºnicas por Plataforma</h3>
        <canvas id="platformClassesChart"></canvas>
      </div>

      <div class="card">
        <h3>Controles</h3>
        <div style="margin-top:6px">
          <div class="filter-row">
            <select id="classFilter"><option value="">Todas las clases</option></select>
            <select id="platformFilter"><option value="">Todas las plataformas</option></select>
            <input id="searchInput" placeholder="Buscar tÃ­tulo..." />
            <button class="btn ghost" onclick="applyFilters()">Filtrar</button>
            <button class="btn ghost" onclick="clearFilters()">Limpiar</button>
          </div>
          <div style="font-size:13px;color:var(--muted)">Tip: usa filtros y luego "Exportar visibles" para sacar solo lo que necesitas.</div>
        </div>
      </div>
    </div>

    <div class="table-area card">
      <h3>Contenido completo</h3>
      <div id="dataTable"></div>
    </div>

    <div class="footer">Creado por Tahamuzza â€” Dashboard Artes Marciales â€¢ Usa la rama correcta para ver los cambios</div>
  </div>

  <script>
    // Intentar cargar CSV externo en data/clase_150_a_192.csv; si no existe, usar fallback (muestra mÃ­nima)
    async function loadRawCSV(){
      try{
        const resp = await fetch('data/clase_150_a_192.csv');
        if(!resp.ok) throw new Error('No CSV externo');
        return await resp.text();
      }catch(e){
        // fallback corto (prueba la UI); reemplaza por tu CSV real si quieres
        return `class_number,title,url,platform,notes
150,Basics.,https://youtu.be/ubODjgurvHM,YouTube,
151,Level 1.,https://youtu.be/BgmUQbOx_bo,YouTube,
188,Calentamiento sho kaimen.,https://youtu.be/lEZM8TsGgp4,YouTube,
192,Liquido medular.,https://youtu.be/7MJuSx142TI,YouTube,`;
      }
    }

    function parseCSV(csv){
      const lines = csv.trim().split('\n');
      const headers = lines[0].split(',').map(h=>h.trim());
      const out = [];
      for(let i=1;i<lines.length;i++){
        const line = lines[i];
        // split only into 5 columns (in case title has commas) â€” join remainder
        const parts = line.split(',');
        if(parts.length < headers.length){
          // skip invalid
          continue;
        }
        const obj = {};
        obj.class_number = parts[0] ? parts[0].trim() : '';
        obj.title = parts[1] ? parts[1].trim() : '';
        // rebuild url (in case commas in title produced extra parts)
        obj.url = parts[2] ? parts[2].trim() : '';
        obj.platform = parts[3] ? parts[3].trim() : '';
        obj.notes = parts.slice(4).join(',') || '';
        out.push(obj);
      }
      return out;
    }

    // Generic helper to download text as file
    function downloadFile(filename, content){
      const blob = new Blob([content], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a);
      a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Render helpers
    function generateColors(n){
      const base = ['rgba(220,20,60,0.85)','rgba(45,80,22,0.85)','rgba(255,215,0,0.85)','rgba(33,150,243,0.85)','rgba(156,39,176,0.85)'];
      const border = base.map(s=>s.replace('0.85','1'));
      const bg = []; const bd = [];
      for(let i=0;i<n;i++){ bg.push(base[i%base.length]); bd.push(border[i%border.length]); }
      return {bg,bd};
    }

    // Charts and table variables
    let allData = [];
    let table = null;
    let platformChart, classCountChart, platformClassesChart;

    async function init(){
      const raw = await loadRawCSV();
      allData = parseCSV(raw);

      // stats
      const platformCounts = {};
      const classCounts = {};
      const platformClasses = {};

      allData.forEach(r=>{
        const p = r.platform || 'Desconocida';
        const c = r.class_number || '';
        platformCounts[p] = (platformCounts[p]||0) + 1;
        classCounts[c] = (classCounts[c]||0) + 1;
        platformClasses[p] = platformClasses[p] || new Set();
        if(c) platformClasses[p].add(c);
      });

      document.getElementById('totalContent').textContent = allData.length;
      document.getElementById('totalClasses').textContent = Object.keys(classCounts).filter(k=>k).length;
      document.getElementById('totalPlatforms').textContent = Object.keys(platformCounts).filter(k=>k).length;

      renderPlatformChart(platformCounts);
      renderClassCountChart(classCounts);
      renderPlatformClassesChart(platformClasses);
      initTable(allData);
      fillFilters(allData);
    }

    function renderPlatformChart(counts){
      const ctx = document.getElementById('platformChart').getContext('2d');
      const labels = Object.keys(counts).sort();
      const data = labels.map(l=>counts[l]);
      const cols = generateColors(labels.length);
      if(platformChart) platformChart.destroy();
      platformChart = new Chart(ctx,{type:'doughnut',data:{labels, datasets:[{data, backgroundColor:cols.bg, borderColor:cols.bd, borderWidth:1}]}, options:{plugins:{legend:{position:'bottom',labels:{color:'#fff'}}}}});
    }
    function renderClassCountChart(counts){
      const ctx = document.getElementById('classCountChart').getContext('2d');
      const entries = Object.entries(counts).filter(e=>e[0]).sort((a,b)=>b[1]-a[1]).slice(0,15);
      const labels = entries.map(e=>`Clase ${e[0]}`), data = entries.map(e=>e[1]);
      const cols = generateColors(labels.length);
      if(classCountChart) classCountChart.destroy();
      classCountChart = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Contenidos',data, backgroundColor:cols.bg[0], borderColor:cols.bd[0], borderWidth:1}]}, options:{indexAxis:'y', plugins:{legend:{display:false}}}});
    }
    function renderPlatformClassesChart(platformClasses){
      const labels = Object.keys(platformClasses).sort();
      const data = labels.map(l=>platformClasses[l].size || 0);
      const cols = generateColors(labels.length);
      const ctx = document.getElementById('platformClassesChart').getContext('2d');
      if(platformClassesChart) platformClassesChart.destroy();
      platformClassesChart = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Clases Ãºnicas',data, backgroundColor:cols.bg, borderColor:cols.bd, borderWidth:1}]}, options:{plugins:{legend:{display:false}}}});
    }

    function initTable(data){
      const tabData = data.map(d=>({class:d.class_number, title:d.title||'Sin tÃ­tulo', platform:d.platform||'Desconocida', url:d.url||'', notes:d.notes||''}));
      table = new Tabulator("#dataTable",{
        data: tabData,
        layout:"fitColumns",
        pagination:"local",
        paginationSize:15,
        movableColumns:true,
        columns:[
          {title:"Clase", field:"class", width:90, sorter:"number"},
          {title:"TÃ­tulo", field:"title", minWidth:200},
          {title:"Plataforma", field:"platform", width:130},
          {title:"Enlace", field:"url", width:140, formatter:function(cell){
            const v = cell.getValue();
            if(!v) return '-';
            const safe = encodeURI(v);
            return `<a href="${safe}" target="_blank" rel="noopener noreferrer">Abrir</a> &nbsp; <a href="${safe}" target="_blank" rel="noopener noreferrer" download>â†“</a>`;
          }},
          {title:"Notas", field:"notes", minWidth:160}
        ],
        initialSort:[{column:"class", dir:"desc"}],
      });
    }

    function fillFilters(data){
      const cf = document.getElementById('classFilter');
      const pf = document.getElementById('platformFilter');
      const classes = [...new Set(data.map(d=>d.class_number))].filter(x=>x).sort((a,b)=>b-a);
      classes.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=`Clase ${c}`; cf.appendChild(o) });
      const plats = [...new Set(data.map(d=>d.platform))].sort();
      plats.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; pf.appendChild(o) });
    }

    function applyFilters(){
      const cls = document.getElementById('classFilter').value;
      const plat = document.getElementById('platformFilter').value;
      const search = document.getElementById('searchInput').value.trim().toLowerCase();
      const filters = [];
      if(cls) filters.push({field:"class", type:"=", value:cls});
      if(plat) filters.push({field:"platform", type:"=", value:plat});
      if(search) filters.push({field:"title", type:"like", value:search});
      table.setFilter(filters);
    }
    function clearFilters(){ document.getElementById('classFilter').value=''; document.getElementById('platformFilter').value=''; document.getElementById('searchInput').value=''; if(table) table.clearFilter() }

    // botones utilitarios
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id === 'btnDownloadCSV'){
        // intentar descargar CSV remoto si existe; si no, generar del array actual
        (async ()=>{
          try{
            const resp = await fetch('data/clase_150_a_192.csv');
            if(resp.ok){ const txt = await resp.text(); downloadFile('clase_150_a_192.csv', txt); return; }
          }catch(err){}
          // fallback: export current table data
          const rows = table.getData();
          const csv = ['class_number,title,url,platform,notes', ...rows.map(r=>[r.class, `"${(r.title||'').replace(/"/g,'""')}"`, r.url, r.platform, `"${(r.notes||'').replace(/"/g,'""')}"`].join(','))].join('\n');
          downloadFile('clase_150_a_192_export.csv', csv);
        })();
      }

      if(e.target && e.target.id === 'btnExportVisible'){
        const rows = table.getData(true); // get visible rows
        const csv = ['class_number,title,url,platform,notes', ...rows.map(r=>[r.class, `"${(r.title||'').replace(/"/g,'""')}"`, r.url, r.platform, `"${(r.notes||'').replace(/"/g,'""')}"`].join(','))].join('\n');
        downloadFile('clase_150_a_192_visible.csv', csv);
      }

      if(e.target && e.target.id === 'btnOpenAll'){
        // abre cada enlace visible en pestaÃ±as nuevas (limit 10 para no spamear)
        const rows = table.getData(true).filter(r=>r.url).slice(0,12);
        rows.forEach(r=>{ window.open(r.url, '_blank', 'noopener') });
      }
    });

    // iniciar
    init();
  </script>
</body>
</html>
